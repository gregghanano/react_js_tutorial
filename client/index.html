<!DOCTYPE html>
<html>
<head>
	<title>Hello React</title>
	<script src='https://fb.me/react-0.13.3.js'></script>
	<script src='https://fb.me/JSXTransformer-0.13.3.js'></script>
	<script src='https://code.jquery.com/jquery-2.1.3.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js'></script>
</head>
<body>
	<div id='content'></div>
	<script type='text/jsx'>
		var data = [
			{author: "Gregg Hanano", text: "This is one comment"},
			{author: "Kristal Delacruz", text: "This is *another* comment"}
		];
		var CommentBox = React.createClass({
			loadCommentsFromServer: function() {
				$.ajax({
					url: this.props.url,
					dataType: 'json',
					cache: false,
					success: function(data) {
						this.setState({data: data});
					}.bind(this),
					error: function(xhr, status, err) {
						console.error(this.props.url, status, err.toString());
					}.bind(this)
				});
			},
			getInitialState: function(){
				return {data: []};
			},
			componentDidMount: function() {
				this.loadCommentsFromServer();
				setInterval(this.loadCommentsFromServer, this.props.pollInterval);
			},
			render: function() {
				return (
					<div className = "commentBox">
						<h1>Comments</h1>
						<CommentList data={this.state.data} />
						<br/>
						<CommentForm />
					</div>
				);
			}
		});
		var CommentList = React.createClass({
			render: function() {
				var commentNodes = this.props.data.map(function (comment) {
					return (
						<Comment author={comment.author}>
							{comment.text}
						</Comment>
						// <div className = "commentList">
						// 	<Comment author="Gregg Hanano">This is one comment</Comment>
						// 	<Comment author='Kristal Delacruz'>This is *another* comment</Comment>
						// </div>
					);
				});
				return (
					<div className = "commentList">
						{commentNodes}
					</div>
				);
			}
		});

		var CommentForm = React.createClass({
			render: function() {
				return (
					<div className = "commentForm">
						Hello, world! I am a CommentForm.
					</div>
				);
			}
		});
		var Comment = React.createClass({
			render: function() {
				var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
				return(
					<div className="comment">
						<h3 className="commentAuthor">
							{this.props.author}
						</h3>
						<span dangerouslySetInnerHTML={{__html: rawMarkup}} />
					</div>
				);
			}
		});

		//Must be last?
		React.render(
			<CommentBox url="comments.json" pollInterval={2000} />,
			document.getElementById('content')
		);
	</script>
</body>
</html>